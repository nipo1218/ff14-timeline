<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³è»½æ¸›è¡¨</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#050505">
  <link rel="manifest" href="manifest.json">
  <link rel="stylesheet" href="timeline-style.css">
  <link rel="stylesheet" href="timeline-viewer-style.css">
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>

  <div class="main-container">
    
    <!-- èªè¨¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="auth-section">
      <button class="auth-btn" id="authBtn" onclick="signInWithGoogle()">
        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google">
        Googleã§ãƒ­ã‚°ã‚¤ãƒ³
      </button>
      <span class="admin-badge" id="adminBadge" style="display: none;">ç®¡ç†è€…</span>
      <span class="user-email" id="userEmail"></span>
    </div>
    
    <!-- ç®¡ç†è€…ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ï¼ˆç®¡ç†è€…ã®ã¿è¡¨ç¤ºï¼‰ -->
    <div class="admin-toolbar admin-only" style="display: none;">
      <button class="admin-btn" onclick="saveGlobalTimeline()">ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚’å…¨ä½“ã«ä¿å­˜</button>
      <button class="admin-btn" onclick="saveGlobalSettings()">è¨­å®šã‚’å…¨ä½“ã«ä¿å­˜</button>
      <label class="admin-toggle">
        <input type="checkbox" id="showMitigationsToggle" checked>
        è»½æ¸›ã‚’é–²è¦§è€…ã«å…¬é–‹
      </label>
    </div>

    <div class="header-section">
      <div class="header-top">
        <div id="timer">00:00</div>
        <div class="controls-upper">
          <button class="btn-start" onclick="startTimer()">è¨ˆæ¸¬é–‹å§‹</button>
          <button class="btn-stop" onclick="stopTimer()">åœæ­¢</button>
          <button class="btn-mic admin-only" id="micBtn" onclick="toggleMic()">ğŸ¤</button>
          <button class="notification-toggle-btn" id="notificationToggleBtn" onclick="toggleNotification()">ğŸ””</button>
        </div>
      </div>

      <!-- ç®¡ç†è€…ç”¨ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ï¼ˆç®¡ç†è€…ã®ã¿è¡¨ç¤ºï¼‰ -->
      <div class="keyboard-area admin-only" style="display: none;">
        
        <div class="keyboard-row">
           <div class="key-btn type-t" onclick="recordTap('single')">
             <span class="key-char">Q</span><span class="key-label">å˜ä½“</span>
           </div>
           <div class="key-btn type-a" onclick="recordTap('pair')">
             <span class="key-char">W</span><span class="key-label">ãƒšã‚¢</span>
           </div>
           <div class="key-btn type-a" onclick="recordTap('stack44')">
             <span class="key-char">E</span><span class="key-label">4:4</span>
           </div>
           <div class="key-btn type-a" onclick="recordTap('role')">
             <span class="key-char">R</span><span class="key-label">ãƒ­ãƒ¼ãƒ«</span>
           </div>
           <div class="key-btn type-t" onclick="recordTap('tank')">
             <span class="key-char">T</span><span class="key-label">ã‚¿ãƒ³ã‚¯</span>
           </div>
        </div>

        <div class="keyboard-row">
           <div class="key-btn type-a" onclick="recordTap('stack')">
             <span class="key-char">A</span><span class="key-label">é ­å‰²ã‚Š</span>
           </div>
           <div class="key-btn type-s" onclick="recordTap('spread')">
             <span class="key-char">S</span><span class="key-label">æ•£é–‹</span>
           </div>
           <div class="key-btn type-s" onclick="recordTap('dot')">
             <span class="key-char">D</span><span class="key-label">Dot</span>
           </div>
           <div class="key-btn type-s" onclick="recordTap('unknown')">
             <span class="key-char">F</span><span class="key-label">ï¼Ÿï¼Ÿï¼Ÿ</span>
           </div>
           <div class="key-btn type-s" onclick="recordTap('gimmick')">
             <span class="key-char">G</span><span class="key-label">ã‚®ãƒŸãƒƒã‚¯</span>
           </div>
           <div class="key-btn type-c" onclick="recordTap('cast_start')">
             <span class="key-char">[</span><span class="key-label">è© å”±å§‹</span>
           </div>
           <div class="key-btn type-c" onclick="recordTap('cast_end')">
             <span class="key-char">]</span><span class="key-label">è© å”±å®Œ</span>
           </div>
        </div>

        <div class="keyboard-row">
           <div class="key-btn type-s" onclick="recordTap('stop')">
             <span class="key-char">Z</span><span class="key-label">å‹•ä½œç¦æ­¢</span>
           </div>
           <div class="key-btn type-s" onclick="recordTap('tower')">
             <span class="key-char">X</span><span class="key-label">å¡”è¸ã¿</span>
           </div>
           <div class="key-btn type-s" onclick="recordTap('gaze')">
             <span class="key-char">C</span><span class="key-label">è¦–ç·š</span>
           </div>
           <div class="key-btn type-s" onclick="recordTap('kb')">
             <span class="key-char">V</span><span class="key-label">ãƒãƒƒã‚¯</span>
           </div>
           <div class="key-btn type-a" onclick="recordTap('burst')">
             <span class="key-char">B</span><span class="key-label">ãƒãƒ¼ã‚¹ãƒˆ</span>
           </div>
           <div class="key-btn" onclick="resetDamageInput()" style="border-top: 2px solid #888;">
             <span class="key-char">.</span><span class="key-label">Reset</span>
           </div>
        </div>

        <div class="keyboard-row">
           <div class="key-btn type-c" style="width: 70px;" onclick="recordSpecialCast(-10)">
             <span class="key-char">Shift</span><span class="key-label">-10ç§’é–‹å§‹</span>
           </div>
           <div class="key-btn type-c" style="width: 70px;" onclick="recordSpecialCast(-5)">
             <span class="key-char">Alt</span><span class="key-label">-5ç§’é–‹å§‹</span>
           </div>
           <div class="key-btn space-key type-c" style="width: 140px;" onclick="recordSpecialCastSpace()">
             <span class="key-char">Space</span>
             <span class="key-label">-3ç§’é–‹å§‹</span>
           </div>
        </div>

      </div>
    </div>

    <div class="tabs-container admin-only" id="tabsContainer" style="display: none;"></div>

    <div class="session-toolbar admin-only" style="display: none;">
      <input type="text" id="defaultPrefixInput" value="ç…‰ç„4å±¤" style="width:60px; text-align:center;">
      <input type="text" id="sessionNameInput" class="input-session-name" oninput="updateSessionName(this.value)">
      <button class="btn-tool btn-copy-all" onclick="copySessionToClipboard()">Copy</button>
      <button class="btn-tool btn-delete-session" onclick="deleteCurrentSession()">å‰Šé™¤</button>
    </div>

    <div class="log-list" id="logList"></div>
  </div>

  <div class="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-title">è¨­å®šãƒ»ãƒœã‚¤ã‚¹</div>
      <div class="playback-section">
        <button class="playback-btn" id="playbackBtn" onclick="togglePlaybackWithNotification()">â–¶</button>
        <div class="playback-display" id="playbackDisplay">-5</div>
        <button class="global-mute-btn" id="globalMuteBtn" onclick="toggleGlobalMute()">ğŸ”‡</button>
      </div>
    </div>

    <div class="sidebar-tabs">
      <button class="sidebar-tab-btn active" data-tab="settings-tab" onclick="switchSidebarTab('settings-tab')">HPè¨­å®š</button>
      <button class="sidebar-tab-btn admin-only" data-tab="voice-tab" onclick="switchSidebarTab('voice-tab')" style="display: none;">ãƒœã‚¤ã‚¹</button>
    </div>

    <div class="sidebar-tab-content" id="settings-tab">
      <div class="hp-settings-section">
        <div class="hp-input-row">
          <span class="hp-input-label">ãƒ’ãƒ¼ãƒ©ãƒ¼HP</span>
          <input type="number" class="hp-input" id="minHpInput" placeholder="ä¾‹: 170000">
        </div>
        <div class="hp-input-row">
          <span class="hp-input-label">ã‚¿ãƒ³ã‚¯HP</span>
          <input type="number" class="hp-input" id="maxHpInput" placeholder="ä¾‹: 200000">
        </div>
        <button class="hp-register-btn" onclick="registerHpSettings()">ç™»éŒ²</button>
      </div>
    </div>

    <div class="sidebar-tab-content hidden admin-only" id="voice-tab" style="display: none;">
      <div class="voice-library-section">
        <div class="voice-add-row">
          <input type="text" class="voice-name-input" id="voiceNameInput" placeholder="åå‰">
          <input type="file" id="voiceFileInput" accept="audio/*" style="display: none;">
          <button class="voice-file-btn" onclick="document.getElementById('voiceFileInput').click()">é¸æŠ</button>
        </div>
        <div class="voice-list" id="voiceList"></div>
      </div>
    </div>
  </div>

  <!-- ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³è¿½åŠ ãƒœã‚¿ãƒ³ï¼ˆå·¦ä¸‹å›ºå®šï¼‰ -->
  <button class="add-timeline-fab" onclick="showAddTimelineModal()" title="ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚’è¿½åŠ ">
    +
  </button>

  <!-- ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal-overlay" id="addTimelineModal">
    <div class="modal-content">
      <div class="modal-header">
        <span class="modal-title">ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚’è¿½åŠ </span>
        <button class="modal-close" onclick="hideAddTimelineModal()">Ã—</button>
      </div>
      <div class="modal-body">
        <div class="modal-input-group">
          <label class="modal-label">æ™‚é–“</label>
          <div class="time-input-row">
            <input type="number" class="time-input-small" id="newTimeMinutes" value="0" min="0" max="20">
            <span class="time-separator">:</span>
            <input type="number" class="time-input-small" id="newTimeSeconds" value="00" min="0" max="59">
          </div>
        </div>
        <div class="modal-input-group">
          <label class="modal-label">ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆæ”»æ’ƒåï¼‰</label>
          <input type="text" class="modal-input" id="newTimeTitle" placeholder="ä¾‹: ãƒãƒ¼ãƒ³ã‚¹ãƒˆãƒ©ã‚¤ã‚¯">
        </div>
        <div class="modal-input-group">
          <label class="modal-label">ãƒ¡ãƒ¢</label>
          <input type="text" class="modal-input" id="newTimeMemo" placeholder="ä¾‹: æ•£é–‹">
        </div>
      </div>
      <div class="modal-footer">
        <button class="modal-btn modal-btn-cancel" onclick="hideAddTimelineModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="modal-btn modal-btn-primary" onclick="addManualTimeline()">è¿½åŠ </button>
      </div>
    </div>
  </div>

  <!-- ã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿é †åº -->
  <script src="timeline-data.js"></script>
  <script src="timeline-firebase.js"></script>
  <script src="timeline-render.js"></script>
  <script src="timeline-viewer.js"></script>
  <script src="timeline-notification.js"></script>
  <script src="timeline-timer.js"></script>
  <script src="timeline-discord.js"></script>
  
  <script>
    // FirebaseåˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', () => {
      initFirebase();
    });
    
    // å†ç”Ÿï¼‹é€šçŸ¥æ©Ÿèƒ½
    function togglePlaybackWithNotification() {
      togglePlayback();
      
      if (isPlaybackRunning) {
        // å†ç”Ÿé–‹å§‹æ™‚ã«é€šçŸ¥ã‚’ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
        const session = sessions.find(s => s.id === currentSessionId);
        if (session && session.logs) {
          const startTime = Date.now() - (playbackSeconds * 1000);
          scheduleNotifications(session.logs, startTime);
        }
      } else {
        // å†ç”Ÿåœæ­¢æ™‚ã«é€šçŸ¥ã‚’ã‚¯ãƒªã‚¢
        clearScheduledNotifications();
      }
    }
    
    // è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ©Ÿèƒ½ã®æ‹¡å¼µ
    const originalUpdatePlayback = typeof updatePlayback === 'function' ? updatePlayback : null;
    
    function updatePlaybackWithScroll() {
      if (originalUpdatePlayback) originalUpdatePlayback();
      
      // ç¾åœ¨æ™‚é–“ã«å¯¾å¿œã™ã‚‹ãƒ­ã‚°ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
      const logs = document.querySelectorAll('.log-item');
      logs.forEach(log => log.classList.remove('current-playback'));
      
      const session = sessions.find(s => s.id === currentSessionId);
      if (!session) return;
      
      // ç¾åœ¨ã®å†ç”Ÿæ™‚é–“ã«æœ€ã‚‚è¿‘ã„ãƒ­ã‚°ã‚’è¦‹ã¤ã‘ã‚‹
      let closestLog = null;
      let closestDiff = Infinity;
      
      session.logs.forEach((log, index) => {
        const logSeconds = parseTime(log.time);
        const diff = Math.abs(logSeconds - playbackSeconds);
        if (diff < closestDiff && logSeconds <= playbackSeconds) {
          closestDiff = diff;
          closestLog = logs[index];
        }
      });
      
      if (closestLog && closestDiff < 3) {
        closestLog.classList.add('current-playback');
        closestLog.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    }
    
    // ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
    function switchSidebarTab(tabId) {
      document.querySelectorAll('.sidebar-tab-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.sidebar-tab-content').forEach(content => content.classList.add('hidden'));
      
      document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
      document.getElementById(tabId).classList.remove('hidden');
    }
    
    // HPè¨­å®šç™»éŒ²
    function registerHpSettings() {
      if (isAdmin) {
        saveGlobalSettings();
      } else {
        saveLocalHpSettings();
      }
      showNotification('HPè¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');
    }
  </script>
</body>
</html>
